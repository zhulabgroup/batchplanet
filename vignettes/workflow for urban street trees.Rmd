---
title: "workflow"
author: "Yiluan Song"
date: "2023-09-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(batchplanet)
```

## Read street tree inventory
```{r, eval = F}
v_site <- c("NY", "SJ", "HT", "DT", "DV", "ST", "AT", "TP")
read_tree_inventory_all(v_site = v_site)
```

```{r}
cityoi <- "DV"
df_tree <- read_tree_inventory(city = cityoi, preload = T)
set_bbox(df_plant = df_tree, siteoi = cityoi)

v_taxa <- c("Quercus", "Morus", "Ulmus", "Fraxinus", "Betula", "Acer", "Populus", "Vacant")
```

## Download PS data
Set some parameters. Replace API key with your own here.
```{r}
setting <- set_ps(api_key = "REMOVED", harmonized = T) # songyl
```

Order. Order IDs saved as rds.
```{r, eval = F}
order_ps_batch(dir = "alldata/PSdata/", df_plant = df_tree, v_site = cityoi, setting = setting)
```

Here, check your Planet account to make sure orders are completed. Make sure all orders are "success" without any order "failed." Once all orders are completed, please do not order the same images repeatedly.

Download. Use Great Lakes R session with 12 cores for this step.
```{r, eval = F}
down_ps_batch(dir = "alldata/PSdata/", v_site = cityoi, setting = setting)
```
Here, tar and compress folders for cities downloaded by submitting Slurm jobs and then move tarred compressed files to Data Den.

## Retrieve time series

Extract time series at tree locations. Use Great Lakes R session with 36 cores for this step.
```{r, eval = F}
proc_ps_ts(dir = "alldata/PSdata/", df_plant = df_tree, v_site = cityoi, v_taxa = v_taxa)
```

Time series preprocessing, including removing low quality data and calculating EVI.
```{r, eval = F}
proc_evi_ts(dir = "alldata/PSdata/", v_site = cityoi, v_taxa = NULL)
```

Visualize the raster.
```{r, eval = F}
vis_raster(path = "alldata/PSdata/raw/SJ/SJ_2017_1_31/20170116_180730_0e30_3B_AnalyticMS_SR_clip.tif", crop_shape = NULL)
```

Read and visualize the evi curve.
```{r}
df_evi <- read_evi(dir = "alldata/PSdata/evi/", v_site = "AT", v_taxa = "Quercus")
vis_ts(df_evi, v_site = "AT", v_taxa = "Quercus", v_id = NULL, n_id = 3, v_year = 2017:2023, smooth = T)
```

## Get day of year for green-up and green-down
```{r, eval = F}
proc_doy(dir = "alldata/PSdata/", v_site = cityoi, v_taxa = NULL, v_year = NULL, v_id = NULL, df_thres = NULL, min_days = 365)
```

```{r}
df_doy <- read_doy(dir = "alldata/PSdata/doy/", v_site = "AT", v_taxa = "Quercus")
df_doy
vis_doy(df_evi, df_doy, v_site = "AT", v_taxa = "Quercus", v_id = NULL, n_id = 5, v_year = 2017:2022, smooth = T)
```

## Read Landsat 8 LST
```{r, eval = F}
proc_mat_ts(dir = "alldata/LSTdata/", df_plant = df_tree, v_site = cityoi, v_taxa = v_taxa)
```

