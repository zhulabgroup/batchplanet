---
title: "workflow for juniper"
author: "Yiluan Song"
date: "2023-10-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(batchplanet)
```

## Read Juniper tree inventory

```{r}
df_tree <- misc_read_juniper_coord(version = NULL)
```

Area too big, so divide them into multiple sites (counties).
```{r}
sp_county <- read_county(country = "US")
# sp_county_sub <- read_county_sub(country = "US", state = "texas") # county subdivision not used
df_tree_county <- util_coord_in_area(df_tree, sp_county, field = "NAME")
```

## Download PS data
Set some parameters. Replace API key with your own here.
```{r}
setting <- set_ps(api_key = "REMOVED") # songyl
```

Order. Order IDs saved as rds.
```{r, eval = F}
order_ps_batch(dir = "alldata/juniper_ashei/PSdata/", df_plant = df_tree_county, v_site = NULL, setting = setting)
```

Here, check your Planet account to make sure orders are completed. Make sure all orders are "success" without any order "failed." Once all orders are completed, please do not order the same images repeatedly.

Download. Use Great Lakes R session with 12 cores for this step.
```{r, eval = F}
down_ps_batch(dir = "alldata/juniper_ashei/PSdata/", v_site = NULL, setting = setting)
```
Here, tar and compress folders for cities downloaded by submitting Slurm jobs and then move tarred compressed files to Data Den.

## Retrieve time series

Extract time series at tree locations. Use Great Lakes R session with 36 cores for this step.
```{r, eval = F}
proc_ps_ts(dir = "alldata/juniper_ashei/PSdata/", df_plant = df_tree_county, v_site = NULL, v_taxa = "Juniper ashei")
```

Time series preprocessing, including removing low quality data and calculating EVI.
```{r, eval = F}
proc_evi_ts(dir = "alldata/juniper_ashei/PSdata/", v_site = NULL, v_taxa = "Juniper ashei")
```

Read in data and visualize.
```{r}
df_index <- read_evi(dir = "alldata/juniper_ashei/PSdata/evi/", v_site = NULL, v_taxa = "Juniper ashei") %>%
  select(-site) %>%
  mutate(r2g = red / green) %>%
  mutate(yellow = (red + green) / blue) %>%
  filter(yellow <= 10) # /(green/blue)*(red-blue+1))
df_index
df_index_version <- df_index %>% left_join(df_tree %>% distinct(id, version))
write_csv(df_index_version, "alldata/juniper_ashei/indices.csv")
```

Calculate and visualize red to green ratio.
```{r}
vis_ts(df_index, var = "r2g", ylab = "R/G", smooth = T)
```

Any difference in the two versions? First version male trees, second version female trees.
```{r}
f_male <- vis_ts(df_index_version %>% filter(version == 1), n_id = 3, var = "r2g", ylab = "R/G", smooth = T, seed = 2)
f_female <- vis_ts(df_index_version %>% filter(version == 2), n_id = 3, var = "r2g", ylab = "R/G", smooth = T, seed = 2)
f_male + f_female
```

Calculate and visualize yellow.
```{r}
vis_ts(df_index, var = "yellow", ylab = "yellow", smooth = T)
```

Any difference in the two versions? First version male trees, second version female trees.
```{r}
f_male <- vis_ts(df_index_version %>% filter(version == 1), n_id = 3, var = "yellow", ylab = "yellow", smooth = T, seed = NULL)
f_female <- vis_ts(df_index_version %>% filter(version == 2), n_id = 3, var = "yellow", ylab = "yellow", smooth = T, seed = NULL)
f_male + f_female
```
