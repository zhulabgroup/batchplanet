---
title: "workflow for NEON"
author: "Yiluan Song"
date: "2024-01-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(batchplanet)
```

## Read NEON tree inventory

```{r}
df_tree <- misc_read_neon_coord()
```
Will download by site.

## Download PS data
Set some parameters. Replace API key with your own here.
```{r}
setting <- set_ps(api_key = "REMOVED", harmonized = T) # songyl
```

Order. Order IDs saved as rds.
```{r, eval = F}
order_ps_batch(dir = "alldata/NEON/", df_plant = df_tree, v_site = NULL, setting = setting)
```

Here, check your Planet account to make sure orders are completed. Make sure all orders are "success" without any order "failed." Once all orders are completed, please do not order the same images repeatedly.

Download. Use Great Lakes R session with 12 cores for this step.
```{r, eval = F}
down_ps_batch(dir = "alldata/NEON/", v_site = NULL, setting = setting)
```
Here, tar and compress folders for cities downloaded by submitting Slurm jobs and then move tarred compressed files to Data Den.

## Retrieve time series

Extract time series at tree locations. Use Great Lakes R session with 36 cores for this step.
```{r, eval = F}
proc_ps_ts(dir = "alldata/NEON/", df_plant = df_tree %>% mutate(taxa = "all"), v_site = NULL, v_taxa = "all")
```

Time series preprocessing, including removing low quality data and calculating EVI.
```{r, eval = F}
proc_evi_ts(dir = "alldata/NEON/", v_site = NULL, v_taxa = "all")
```

Read in data and visualize.
```{r}
df_evi <- read_evi(dir = "alldata/NEON/evi/", v_site = "BART", v_taxa = "all")
vis_ts(df_evi, var = "evi", ylab= "EVI", smooth = T)
```

## Get day of year for green-up and green-down
```{r, eval = F}
proc_doy(dir = "alldata/NEON/", v_site = NULL, v_taxa = "all", v_year = NULL, v_id = NULL, df_thres = NULL, min_days = 365)
